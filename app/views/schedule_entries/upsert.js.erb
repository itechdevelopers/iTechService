var $cell = $('.schedule-cell[data-user-id="<%= @entry.user_id %>"][data-date="<%= @entry.date %>"]');

<% if @entry.display_text.present? %>
  $cell.html('<%= j @entry.display_text %>');
  $cell.css('background-color', '<%= @entry.background_color %>');
  $cell.removeClass('empty-cell');
<% else %>
  $cell.html('');
  $cell.css('background-color', '#ffffff');
  $cell.addClass('empty-cell');
<% end %>

$cell.data('entry-id', <%= @entry.id %>);

// Update weekly hours
<% @weekly_hours.each do |user_id, hours| %>
$('.weekly-hours-cell[data-user-id="<%= user_id %>"]').text('<%= hours %>');
<% end %>

// Create new department summary tables if needed
<% if @new_tables&.any? %>
(function() {
  var $container = $('#department-summaries');
  if ($container.length === 0) {
    $container = $('<div id="department-summaries" class="department-summaries"></div>');
    $('.save-section').before($container);
  }
  <% @new_tables.each do |table_data| %>
  $container.append('<%= j render(partial: "schedule_groups/department_summary_table", locals: { dept_id: table_data[:dept_id], department_name: table_data[:department_name], columns: table_data[:columns], counts: table_data[:counts], week_dates: @week_dates }) %>');
  <% end %>
})();
<% end %>

// Add new columns to existing department summary tables
<% if @new_columns&.any? %>
(function() {
  <% @new_columns.each do |col_data| %>
  (function() {
    var $table = $('.department-summary-table[data-department-id="<%= col_data[:dept_id] %>"]');
    if ($table.length === 0) return;

    // Add header
    $table.find('thead tr').append('<%= j render(partial: "schedule_groups/department_summary_column", locals: { shift_id: col_data[:shift_id], display_text: col_data[:display_text] }) %>');

    // Add cells to each row by date
    <% @week_dates.each do |date| %>
    <% data = col_data[:counts][[col_data[:shift_id], date]] || { count: 0, users: [], not_assigned: [] } %>
    <% count = data[:count] %>
    <% users = data[:users] %>
    <% not_assigned = data[:not_assigned] || [] %>
    <% tooltip_parts = [] %>
    <% tooltip_parts << "#{t('schedule_groups.show.assigned')}: #{users.join(', ')}" if users.any? %>
    <% tooltip_parts << "#{t('schedule_groups.show.not_assigned')}: #{not_assigned.join(', ')}" if not_assigned.any? %>
    $table.find('tbody tr[data-date="<%= date.to_s %>"]').append('<td class="summary-count-cell" data-department-id="<%= col_data[:dept_id] %>" data-shift-id="<%= col_data[:shift_id] %>" data-date="<%= date.to_s %>" data-users="<%= j users.join(',') %>" data-not-assigned="<%= j not_assigned.join(',') %>" data-original-title="<%= j tooltip_parts.join(' | ') %>" rel="tooltip"><%= count > 0 ? count : "" %></td>');
    <% end %>
  })();
  <% end %>
})();
<% end %>

// Update department summary counts and user lists
<% @department_counts.each do |(dept_id, shift_id, date), data| %>
(function() {
  var $cell = $('.summary-count-cell[data-department-id="<%= dept_id %>"][data-shift-id="<%= shift_id %>"][data-date="<%= date %>"]');
  var count = <%= data[:count] %>;
  var users = '<%= j data[:users].join(",") %>';
  var notAssigned = '<%= j data[:not_assigned].join(",") %>';
  var tooltipParts = [];
  if (users) tooltipParts.push('<%= j t("schedule_groups.show.assigned") %>: ' + users.split(',').join(', '));
  if (notAssigned) tooltipParts.push('<%= j t("schedule_groups.show.not_assigned") %>: ' + notAssigned.split(',').join(', '));
  $cell.text(count > 0 ? count : '');
  $cell.attr('data-users', users);
  $cell.attr('data-not-assigned', notAssigned);
  $cell.attr('data-original-title', tooltipParts.join(' | '));
})();
<% end %>
