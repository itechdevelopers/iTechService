- content_for :title, @schedule_group.name

%h3= @schedule_group.name

.row-fluid
  .span12
    %p
      = link_to schedules_path(city_id: @city.id), class: 'btn' do
        = glyph(:'arrow-left')
        = t('.back_to_schedules')

%hr

-# PNG export hint (shown when disabled, above navigation)
- png_disabled = @can_edit && (@snapshot.nil? || @has_unsaved_changes)
- if png_disabled
  %p#export-hint.export-hint.text-warning.text-right= t('.save_to_export_hint')

-# Week navigation
.row-fluid
  .span12
    .btn-toolbar
      .btn-group
        = link_to schedule_group_path(@schedule_group, week: @week_start - 7.days), class: 'btn' do
          = glyph(:'chevron-left')
          = t('.prev_week')
        %span.btn.disabled
          = l(@week_start, format: '%d.%m')
          \-
          = l(@week_start + 6.days, format: '%d.%m.%Y')
        = link_to schedule_group_path(@schedule_group, week: @week_start + 7.days), class: 'btn' do
          = t('.next_week')
          = glyph(:'chevron-right')
      .btn-group.pull-right
        - if can?(:manage, :schedule)
          = link_to history_schedule_group_path(@schedule_group, week: @week_start), remote: true, class: 'btn' do
            = glyph(:time)
            = t('.history')
        %button#export-png-btn.btn{'data-group-name' => @schedule_group.name, 'data-week-start' => l(@week_start, format: '%d.%m.%Y'), 'data-week-end' => l(@week_start + 6.days, format: '%d.%m.%Y'), disabled: png_disabled}
          = glyph(:download)
          = t('.export_png')

%hr

-# Selection panel (only if can edit)
- if @can_edit
  #selection-panel.well.well-small
    .row-fluid
      .span3
        %h5= t('.department')
        .btn-group.selection-group{'data-selection' => 'department'}
          - @departments.each do |dept|
            %button.btn.btn-small.selection-btn{'data-id' => dept.id, 'data-short-name' => dept.schedule_config.short_name, 'data-color' => dept.schedule_config.color}
              .btn-label= dept.name
              %span.btn-hint-badge{style: "background-color: #{dept.schedule_config.color}"}= dept.schedule_config.short_name
      .span3
        %h5= t('.shift')
        .btn-group.selection-group{'data-selection' => 'shift'}
          - @shifts.each do |shift|
            %button.btn.btn-small.selection-btn{'data-id' => shift.id, 'data-short-name' => shift.short_name}
              .btn-label= shift.name
              .btn-hint= shift.short_name
      .span3
        %h5= t('.occupation_type')
        .btn-group.selection-group{'data-selection' => 'occupation_type'}
          - @occupation_types.each do |ot|
            %button.btn.btn-small.selection-btn{'data-id' => ot.id, 'data-color' => ot.color, 'data-counts-as-working' => ot.counts_as_working.to_s}
              .btn-label= ot.name
              %span.btn-hint-color{style: "background-color: #{ot.color}"}
      .span3
        %h5 &nbsp;
        %button#clear-selection-btn.btn.btn-warning.btn-small
          = glyph(:remove)
          = t('.clear_cell')

%hr

-# Schedule table
.table-responsive
  %table.table.table-bordered.schedule-table{'data-schedule-group-id' => @schedule_group.id, 'data-can-edit' => @can_edit.to_s, 'data-week-start' => @week_start.to_s}
    %caption.schedule-table-caption
      = @schedule_group.name
      %span.schedule-table-week
        = "(#{l(@week_start, format: '%d.%m')} - #{l(@week_start + 6.days, format: '%d.%m.%Y')})"
    %thead
      %tr
        %th= t('.date')
        %th= t('.day_of_week')
        - @members.each do |member|
          %th.member-header{'data-user-id' => member.id}
            = member.short_name
    %tbody
      - @week_dates.each do |date|
        %tr
          %td.date-cell{'data-date' => date.to_s}= l(date, format: '%d.%m.%Y')
          %td.weekday-cell= l(date, format: '%A')
          - @members.each do |member|
            - entry = @entries[[member.id, date]]
            - cell_data = {'data-user-id' => member.id, 'data-date' => date.to_s}
            - cell_data['data-entry-id'] = entry.id if entry
            - if entry && entry.display_text
              %td.schedule-cell{cell_data.merge(style: "background-color: #{entry.background_color}")}
                = entry.display_text
            - else
              %td.schedule-cell.empty-cell{cell_data}
    %tfoot.weekly-hours-footer
      %tr
        %td{colspan: 2}= t('.weekly_days_off')
        - @members.each do |member|
          %td.weekly-days-off-cell{'data-user-id' => member.id}
            = @weekly_days_off[member.id] if @weekly_days_off[member.id] > 0
      %tr
        %td{colspan: 2}= t('.weekly_hours')
        - @members.each do |member|
          %td.weekly-hours-cell{'data-user-id' => member.id}
            = @weekly_hours[member.id]

-# Department shift summary tables (always render container for dynamic updates)
#department-summaries.department-summaries
  - @department_summaries.each do |dept_id, summary|
    = render partial: 'department_summary_table', locals: { dept_id: dept_id, department_name: summary[:department].name, columns: summary[:columns], counts: summary[:counts], week_dates: @week_dates }

-# Week memos (ПАМЯТКА)
.week-memos-section
  %h5.week-memos-title= t('schedule_week_memos.title')
  %table.table.table-bordered.table-condensed.week-memos-table
    %tbody#memo-table-body
      - if @memos.any?
        - @memos.each do |memo|
          = render partial: 'schedule_week_memos/memo_row', locals: { memo: memo, can_edit: @can_edit, schedule_group: @schedule_group }
      - else
        %tr#no-memos-row
          %td.muted.text-center{colspan: @can_edit ? 2 : 1}= t('schedule_week_memos.empty')
  - if @can_edit
    = link_to '#', class: 'btn btn-small memo-add-btn', id: 'add-memo-btn', 'data-url' => schedule_group_schedule_week_memos_path(@schedule_group), 'data-week-start' => @week_start.to_s do
      = glyph(:plus)
      = t('schedule_week_memos.add')

-# Save button and status (under table)
- if @can_edit
  .save-section
    %button#save-schedule-btn.btn.btn-primary{'data-url' => save_week_schedule_group_path(@schedule_group, week: @week_start), 'data-has-unsaved' => (@snapshot.nil? || @has_unsaved_changes).to_s}
      = glyph(:ok)
      %span.btn-text= (@snapshot.nil? || @has_unsaved_changes) ? t('.save_schedule_unsaved') : t('.save_schedule')
    #save-status.save-status
      - if @snapshot
        - city_tz = @city.time_zone || 'Vladivostok'
        - saved_at_local = @snapshot.saved_at.in_time_zone(city_tz)
        - if @has_unsaved_changes
          %span.text-warning
            = glyph(:'exclamation-sign')
            = t('.updated_at', date: l(saved_at_local, format: :short))
        - else
          %span.text-success
            = glyph(:ok)
            - if @snapshot.created_at == @snapshot.updated_at
              = t('.saved_at', date: l(saved_at_local, format: :short))
            - else
              = t('.updated_at', date: l(saved_at_local, format: :short))

:css
  /* Selection panel */
  #selection-panel h5 {
    margin-bottom: 8px;
    font-weight: bold;
  }
  #selection-panel .btn-group {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
  }
  #selection-panel .selection-btn {
    margin-bottom: 4px;
  }
  #selection-panel .selection-btn.active {
    background-color: #0088cc;
    color: white;
    box-shadow: inset 0 3px 5px rgba(0,0,0,0.125);
  }

  /* Scrollable table container */
  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  /* Schedule table */
  .schedule-table-caption {
    caption-side: top;
    text-align: center;
    font-size: 18px;
    font-weight: bold;
    padding: 10px;
    color: #333;
    background-color: #fff;
  }
  .schedule-table-caption .schedule-table-week {
    font-weight: normal;
    color: #666;
  }
  .schedule-table th, .schedule-table td {
    text-align: center;
    vertical-align: middle;
  }
  .schedule-table .date-cell {
    min-width: 100px;
    max-width: 100px;
    width: 100px;
    white-space: nowrap;
  }
  .schedule-table .weekday-cell {
    min-width: 120px;
    max-width: 120px;
    width: 120px;
  }

  /* Sticky first two columns */
  .schedule-table thead th:nth-child(1),
  .schedule-table tbody td:nth-child(1),
  .schedule-table tfoot td:first-child {
    position: sticky;
    left: 0;
    z-index: 2;
    background-color: #f9f9f9;
  }
  .schedule-table thead th:nth-child(1) {
    min-width: 100px;
    max-width: 100px;
    width: 100px;
  }
  .schedule-table thead th:nth-child(2),
  .schedule-table tbody td:nth-child(2) {
    position: sticky;
    left: 100px;
    z-index: 2;
    background-color: #f9f9f9;
    box-shadow: 2px 0 4px rgba(0,0,0,0.1);
  }
  .schedule-table thead th:nth-child(2) {
    min-width: 120px;
    max-width: 120px;
    width: 120px;
  }
  .schedule-table thead th:nth-child(1),
  .schedule-table thead th:nth-child(2) {
    z-index: 3;
    background-color: #f5f5f5;
  }
  .schedule-table tfoot td:first-child {
    left: 0;
    z-index: 2;
  }
  .schedule-table .member-header {
    min-width: 80px;
  }
  .schedule-table .schedule-cell {
    min-width: 60px;
    height: 40px;
  }
  .schedule-table .empty-cell {
    background-color: #ffffff;
  }
  .schedule-table[data-can-edit="true"] .schedule-cell {
    cursor: pointer;
  }
  .schedule-table[data-can-edit="true"] .schedule-cell:hover {
    opacity: 0.8;
  }
  .schedule-table[data-can-edit="true"] .member-header,
  .schedule-table[data-can-edit="true"] .date-cell {
    cursor: pointer;
  }
  .schedule-table[data-can-edit="true"] .member-header:hover,
  .schedule-table[data-can-edit="true"] .date-cell:hover {
    background-color: #f5f5f5;
  }

  /* Weekly hours footer */
  .schedule-table .weekly-hours-footer td {
    background-color: #f9f9f9;
    font-weight: bold;
    border-top: 2px solid #ddd;
  }
  .schedule-table .weekly-hours-cell,
  .schedule-table .weekly-days-off-cell {
    text-align: center;
  }

  /* Department summary tables */
  .department-summaries {
    margin-top: 24px;
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
  }
  .department-summary {
    flex: 0 0 auto;
  }
  .department-summary-title {
    font-weight: bold;
    margin-bottom: 6px;
  }
  .department-summary-table {
    width: auto;
  }
  .department-summary-table th,
  .department-summary-table td {
    text-align: center;
    vertical-align: middle;
    padding: 4px 10px;
  }
  .department-summary-table .weekday-cell {
    text-align: left;
    font-weight: normal;
  }
  .summary-count-cell:empty {
    background-color: #f9f9f9;
  }

  /* Export hint (above navigation, right-aligned) */
  .export-hint {
    font-size: 12px;
    margin-bottom: 5px;
  }

  /* Save section (button + status) */
  .save-section {
    margin-top: 16px;
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .save-status {
    font-size: 13px;
  }

  /* Week memos (ПАМЯТКА) */
  .week-memos-section {
    margin-top: 24px;
    max-width: 600px;
  }
  .week-memos-title {
    font-weight: bold;
    margin-bottom: 6px;
  }
  .week-memos-table {
    width: 100%;
  }
  .week-memos-table .memo-content-cell {
    width: 100%;
  }
  .week-memos-table .memo-actions-cell {
    white-space: nowrap;
    width: 1%;
  }
  .week-memos-table .memo-input {
    margin-bottom: 0;
    width: 95%;
  }
  .memo-add-btn {
    margin-top: 8px;
  }

:javascript
  $(document).ready(function() {
    // Initialize tooltips for department summary cells
    $('#department-summaries').tooltip({
      selector: '.summary-count-cell[data-original-title]',
      placement: 'top',
      container: 'body',
      html: true
    });

    // Selection state
    var selection = {
      department: null,
      shift: null,
      occupation_type: null,
      clear_mode: false
    };

    // Toggle selection on button click
    $('#selection-panel .selection-btn').on('click', function() {
      var $btn = $(this);
      var $group = $btn.closest('.selection-group');
      var selectionType = $group.data('selection');

      // Disable clear mode when selecting
      selection.clear_mode = false;
      $('#clear-selection-btn').removeClass('active');

      // Toggle: if already selected, deselect; otherwise select
      if ($btn.hasClass('active')) {
        $btn.removeClass('active');
        selection[selectionType] = null;
      } else {
        $group.find('.selection-btn').removeClass('active');
        $btn.addClass('active');
        var selectionData = {
          id: $btn.data('id'),
          short_name: $btn.data('short-name'),
          color: $btn.data('color')
        };
        // Add counts_as_working for occupation_type
        if (selectionType === 'occupation_type') {
          selectionData.counts_as_working = $btn.data('counts-as-working') === true || $btn.data('counts-as-working') === 'true';
        }
        selection[selectionType] = selectionData;
      }

      updateSelectionStatus();
    });

    // Clear mode toggle
    $('#clear-selection-btn').on('click', function() {
      var $btn = $(this);
      selection.clear_mode = !selection.clear_mode;
      $btn.toggleClass('active', selection.clear_mode);

      // Deselect all when entering clear mode
      if (selection.clear_mode) {
        $('#selection-panel .selection-btn').removeClass('active');
        selection.department = null;
        selection.shift = null;
        selection.occupation_type = null;
      }

      updateSelectionStatus();
    });

    function updateSelectionStatus() {
      console.log('Selection:', selection);
    }

    // Cell click handler
    var $table = $('.schedule-table');
    var scheduleGroupId = $table.data('schedule-group-id');
    var canEdit = $table.data('can-edit');
    var weekStart = $table.data('week-start');

    console.log('Table found:', $table.length > 0);
    console.log('Schedule group ID:', scheduleGroupId);
    console.log('Week start:', weekStart);
    console.log('Can edit (raw):', canEdit, typeof canEdit);

    // data-can-edit returns string "true"/"false", need to compare
    var canEditBool = (canEdit === true || canEdit === 'true');
    console.log('Can edit (bool):', canEditBool);

    if (canEditBool) {
      console.log('Attaching click handler to .schedule-cell');
      $table.on('click', '.schedule-cell', function() {
        console.log('Cell clicked!');
        var $cell = $(this);
        var userId = $cell.data('user-id');
        var date = $cell.data('date');
        var entryId = $cell.data('entry-id');
        console.log('Cell data:', { userId: userId, date: date, entryId: entryId });

        // Clear mode: delete entry
        if (selection.clear_mode) {
          if (entryId) {
            $.ajax({
              url: '/schedule_groups/' + scheduleGroupId + '/schedule_entries/' + entryId,
              method: 'DELETE',
              dataType: 'script',
              data: { week: weekStart },
              success: function() { window.markScheduleUnsaved && window.markScheduleUnsaved(); }
            });
          }
          return;
        }

        // Validate selection: occupation_type always required
        // department and shift required only if counts_as_working
        if (!selection.occupation_type) {
          alert('Выберите занятость');
          return;
        }
        if (selection.occupation_type.counts_as_working && (!selection.department || !selection.shift)) {
          alert('Для рабочей занятости выберите подразделение и смену');
          return;
        }

        // Upsert entry
        console.log('Sending upsert request...');
        $.ajax({
          url: '/schedule_groups/' + scheduleGroupId + '/schedule_entries/upsert',
          method: 'POST',
          dataType: 'script',
          data: {
            user_id: userId,
            date: date,
            week: weekStart,
            department_id: selection.department ? selection.department.id : null,
            shift_id: selection.shift ? selection.shift.id : null,
            occupation_type_id: selection.occupation_type.id
          },
          success: function() {
            console.log('Upsert success!');
            window.markScheduleUnsaved && window.markScheduleUnsaved();
          },
          error: function(xhr, status, error) {
            console.error('Upsert error:', status, error, xhr.responseText);
          }
        });
      });
    } else {
      console.log('Edit disabled, not attaching click handler');
    }

    // Batch fill: click on member header → fill entire row (all week for this user)
    if (canEditBool) {
      $table.on('click', '.member-header', function() {
        var userId = $(this).data('user-id');
        if (!userId) return;

        if (selection.clear_mode) {
          // Batch clear for user
          $.ajax({
            url: '/schedule_groups/' + scheduleGroupId + '/schedule_entries/batch_destroy',
            method: 'DELETE',
            dataType: 'script',
            data: { user_id: userId, week: weekStart },
            success: function() { window.markScheduleUnsaved && window.markScheduleUnsaved(); }
          });
          return;
        }

        // Validate selection for batch upsert
        if (!selection.occupation_type) {
          alert('Выберите занятость');
          return;
        }
        if (selection.occupation_type.counts_as_working && (!selection.department || !selection.shift)) {
          alert('Для рабочей занятости выберите подразделение и смену');
          return;
        }

        $.ajax({
          url: '/schedule_groups/' + scheduleGroupId + '/schedule_entries/batch_upsert',
          method: 'POST',
          dataType: 'script',
          data: {
            user_id: userId,
            week: weekStart,
            department_id: selection.department ? selection.department.id : null,
            shift_id: selection.shift ? selection.shift.id : null,
            occupation_type_id: selection.occupation_type.id
          },
          success: function() { window.markScheduleUnsaved && window.markScheduleUnsaved(); }
        });
      });

      // Batch fill: click on date cell → fill entire column (all users for this date)
      $table.on('click', '.date-cell', function() {
        var date = $(this).data('date');
        if (!date) return;

        if (selection.clear_mode) {
          // Batch clear for date
          $.ajax({
            url: '/schedule_groups/' + scheduleGroupId + '/schedule_entries/batch_destroy',
            method: 'DELETE',
            dataType: 'script',
            data: { date: date, week: weekStart },
            success: function() { window.markScheduleUnsaved && window.markScheduleUnsaved(); }
          });
          return;
        }

        // Validate selection for batch upsert
        if (!selection.occupation_type) {
          alert('Выберите занятость');
          return;
        }
        if (selection.occupation_type.counts_as_working && (!selection.department || !selection.shift)) {
          alert('Для рабочей занятости выберите подразделение и смену');
          return;
        }

        $.ajax({
          url: '/schedule_groups/' + scheduleGroupId + '/schedule_entries/batch_upsert',
          method: 'POST',
          dataType: 'script',
          data: {
            date: date,
            week: weekStart,
            department_id: selection.department ? selection.department.id : null,
            shift_id: selection.shift ? selection.shift.id : null,
            occupation_type_id: selection.occupation_type.id
          },
          success: function() { window.markScheduleUnsaved && window.markScheduleUnsaved(); }
        });
      });
    }

    // Expose selection
    window.scheduleSelection = selection;

    // === Save Schedule functionality ===
    var $saveBtn = $('#save-schedule-btn');
    var $exportBtn = $('#export-png-btn');
    var hasUnsavedChanges = $saveBtn.data('has-unsaved') === true || $saveBtn.data('has-unsaved') === 'true';

    // Translations (embedded from Rails)
    var i18n = {
      save_schedule: '#{j t('.save_schedule')}',
      save_schedule_unsaved: '#{j t('.save_schedule_unsaved')}',
      saving: '#{j t('.saving')}',
      saved_at: '#{j t('.saved_at', date: '__DATE__')}',
      updated_at: '#{j t('.updated_at', date: '__DATE__')}',
      save_to_export_hint: '#{j t('.save_to_export_hint')}'
    };

    // Mark as having unsaved changes (called after cell modifications)
    window.markScheduleUnsaved = function() {
      hasUnsavedChanges = true;
      updateSaveButtonState();
    };

    function updateSaveButtonState() {
      var $hint = $('#export-hint');
      if (hasUnsavedChanges) {
        $saveBtn.find('.btn-text').text(i18n.save_schedule_unsaved);
        $exportBtn.prop('disabled', true);
        // Show or create hint (above navigation row)
        if ($hint.length === 0) {
          $('.btn-toolbar').first().before('<p id="export-hint" class="export-hint text-warning text-right">' + i18n.save_to_export_hint + '</p>');
        } else {
          $hint.show();
        }
      } else {
        $saveBtn.find('.btn-text').text(i18n.save_schedule);
        $exportBtn.prop('disabled', false);
        $hint.hide();
      }
    }

    // Save schedule button click
    $saveBtn.on('click', function() {
      var $btn = $(this);
      var url = $btn.data('url');
      var originalHtml = $btn.html();

      $btn.prop('disabled', true).html('<i class="icon-spinner icon-spin"></i> ' + i18n.saving);

      $.ajax({
        url: url,
        method: 'POST',
        dataType: 'json',
        success: function(response) {
          if (response.success) {
            hasUnsavedChanges = false;
            updateSaveButtonState();

            // Update status text
            var statusText = response.first_save
              ? i18n.saved_at.replace('__DATE__', response.saved_at)
              : i18n.updated_at.replace('__DATE__', response.saved_at);

            $('#save-status').html('<span class="text-success"><i class="icon-ok"></i> ' + statusText + '</span>');
          }
          $btn.prop('disabled', false).html(originalHtml);
          updateSaveButtonState();
        },
        error: function(xhr) {
          alert('Ошибка сохранения');
          $btn.prop('disabled', false).html(originalHtml);
        }
      });
    });

    // Export to PNG
    var exportBtnOriginalHtml = $exportBtn.html();

    $exportBtn.on('click', function() {
      var $btn = $(this);
      var groupName = $btn.data('group-name');
      var weekStart = $btn.data('week-start');
      var weekEnd = $btn.data('week-end');
      var $table = $('.schedule-table');

      // Disable button during export
      $btn.prop('disabled', true).html('<i class="icon-spinner icon-spin"></i> Экспорт...');

      // Load html2canvas dynamically if not already loaded
      if (typeof html2canvas === 'undefined') {
        var script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        script.onload = function() {
          doExport($table, groupName, weekStart, weekEnd, $btn);
        };
        script.onerror = function() {
          alert('Не удалось загрузить библиотеку экспорта');
          $btn.prop('disabled', false).html(exportBtnOriginalHtml);
        };
        document.head.appendChild(script);
      } else {
        doExport($table, groupName, weekStart, weekEnd, $btn);
      }
    });

    function doExport($table, groupName, weekStart, weekEnd, $btn) {
      // Hide weekly hours footer for export
      var $footer = $table.find('.weekly-hours-footer');
      $footer.hide();

      html2canvas($table[0], {
        backgroundColor: '#ffffff',
        scale: 2
      }).then(function(canvas) {
        // Show footer again
        $footer.show();

        // Create download link
        var link = document.createElement('a');
        var filename = groupName.replace(/\s+/g, '_') + '_' + weekStart.replace(/\./g, '-') + '_' + weekEnd.replace(/\./g, '-') + '.png';
        link.download = filename;
        link.href = canvas.toDataURL('image/png');
        link.click();

        // Restore button
        $btn.prop('disabled', false).html(exportBtnOriginalHtml);
      }).catch(function(error) {
        // Show footer again even on error
        $footer.show();
        console.error('Export error:', error);
        alert('Ошибка при экспорте');
        $btn.prop('disabled', false).html(exportBtnOriginalHtml);
      });
    }

    // === Week Memos (ПАМЯТКА) ===
    // Add memo
    $('#add-memo-btn').on('click', function(e) {
      e.preventDefault();
      var url = $(this).data('url');
      var weekStart = $(this).data('week-start');
      $.ajax({
        url: url,
        method: 'POST',
        dataType: 'script',
        data: {
          schedule_week_memo: { content: '...', week_start: weekStart }
        }
      });
    });

    // Edit memo — switch to edit mode
    $(document).on('click', '.memo-edit-btn', function(e) {
      e.preventDefault();
      var $row = $(this).closest('.memo-row');
      $row.find('.memo-text').hide();
      $row.find('.memo-input').show().focus().select();
      $row.find('.memo-display-actions').hide();
      $row.find('.memo-edit-actions').show();
    });

    // Cancel edit
    $(document).on('click', '.memo-cancel-btn', function(e) {
      e.preventDefault();
      var $row = $(this).closest('.memo-row');
      var originalText = $row.find('.memo-text').text();
      $row.find('.memo-input').val(originalText).hide();
      $row.find('.memo-text').show();
      $row.find('.memo-edit-actions').hide();
      $row.find('.memo-display-actions').show();
    });

    // Save memo edit
    $(document).on('click', '.memo-save-btn', function(e) {
      e.preventDefault();
      var $row = $(this).closest('.memo-row');
      var memoId = $row.data('memo-id');
      var newContent = $row.find('.memo-input').val();
      $.ajax({
        url: '/schedule_groups/' + scheduleGroupId + '/schedule_week_memos/' + memoId,
        method: 'PATCH',
        dataType: 'script',
        data: { schedule_week_memo: { content: newContent } }
      });
    });

    // Save memo on Enter key
    $(document).on('keydown', '.memo-input', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        $(this).closest('.memo-row').find('.memo-save-btn').click();
      }
      if (e.key === 'Escape') {
        e.preventDefault();
        $(this).closest('.memo-row').find('.memo-cancel-btn').click();
      }
    });
  });
